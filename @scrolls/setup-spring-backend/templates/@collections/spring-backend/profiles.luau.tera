--!strict

local PropTypes = require('@lorry.project/lib/PropTypes')
local Profile = require('@lorry.project-spring/lib/Profile/Profile')

local modules = require('./modules')

local profiles = {}

export type Profiles = typeof(profiles)

local server_port = 8080

local datasource: PropTypes.Datasource = {
  url = 'jdbc:postgresql://localhost:5432/app',
  username = 'app',
  password = 'app',
}

local openid_remote: PropTypes.OpenidRemote = {
  url = 'http://env-keycloak:8080/auth',
  client_id = 'api',
  client_secret = '4Ggxc50xzu5j1qFk5rZ4OPHwvNFXLpNX',
  issuer_uri = 'http://auth.local.example.com/auth/realms/application',
  redirect_uri = '{referer}/auth/callback',
}

local minio_remote: PropTypes.MinioRemote = {
  target_server = 'http://minio.local.example.com',
  access_key = 'y5LeRZ84J4SsenpaIxMl',
  secret_key = 'AZitoDkffcEYFYUmV4CGv1jr2fiXWIw4uSvdFlDu',
}

{%- for catalog in db.catalogs %}
{# Blank line #}
profiles.profile_{{ catalog.catalog_name }}_assembly = Profile
  :from(modules.assembly_{{ catalog.catalog_name }})
  :with_server_port(server_port)
  :with_app_openid_remote(openid_remote)
  :with_app_minio_client(minio_remote)
  :with_spring_jpa(true)
  :with_spring_datasource(datasource)
  :configure {
    function(impl) assert(impl.app_minio_client)
      :with_bucket 'app-public-document'
      :with_bucket('app-public-image', { content_type = 'image/', content_length = '10M' })
      :with_bucket('app-product-image', { content_type = 'image/', content_length = '10M' })
    end
  }
{%- endfor %}

{%- for schema in db.schemas %}
{# Blank line #}
profiles.profile_{{ schema.catalog_name }}_{{ schema.schema_name }}_web = Profile
  :from(modules.service_{{ schema.catalog_name }}_{{ schema.schema_name }})
  :with_server_port(server_port)
  :with_app_openid_remote(openid_remote)
  :with_app_minio_client(minio_remote)
  :with_spring_jpa(true)
  :with_spring_datasource(datasource)
  :configure {
    function(impl) assert(impl.app_minio_client)
      :with_bucket 'app-public-document'
      :with_bucket('app-public-image', { content_type = 'image/', content_length = '10M' })
      :with_bucket('app-product-image', { content_type = 'image/', content_length = '10M' })
    end
  }
{%- endfor %}

return profiles
